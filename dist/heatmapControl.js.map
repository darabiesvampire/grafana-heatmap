{"version":3,"sources":["../src/heatmapControl.js"],"names":["ensureArrayContains","array","value","indexOf","push","colorToHex","color","substr","digits","replace","split","length","red","parseInt","green","blue","rgba","toString","getColorByXPercentage","canvas","xPercent","x","width","context","getContext","p","getImageData","data","TimeSeries","kbn","MetricsPanelCtrl","heatmapEditor","displayEditor","pluginName","_","moment","panelOptions","aggregationFunctions","treeMap","modes","timestampFormats","panelDefaults","seriesOverrides","thresholds","colors","legend","show","min","max","avg","current","total","detangle","coupling","sortingOrder","limit","metric","sourceType","targetType","sourceTypeData","targetTypeData","minIssuesPerFile","minIssuesData","minFilesPerIssue","minFilesData","issueTitle","issueTitleData","fileExcludeFilter","fileExcludeFilterData","fileGroup","fileGroupData","metricRange","metricRangeData","cohesionCalculationMethod","isAuthorDashboard","maxDataPoints","mappingType","nullPointMode","format","valueMaps","op","text","mode","groups","key","colorByFunction","sizeByFunction","enableTimeBlocks","enableGrouping","debug","depth","ids","nodeSizeProperty","HeatmapCtrl","$scope","$injector","$sce","detangleSrv","templateSrv","defaults","panel","options","chartId","id","containerDivId","events","on","onInitEditMode","bind","onDataReceived","initializePanel","d3plusPath","_this","meta","SystemJS","config","import","then","d3plusLoaded","emit","couplingMetrics","cohesionCalculationMethods","err","getPanelContainer","html","addEditorTab","$","document","getElementById","dataList","undefined","dataConvertor","series","map","seriesHandler","preparedData","d3plusDataProcessor","render","group","dataArray","resultArray","hasGroups","dataIndex","newDataItem","Object","assign","stats","groupArray","groupIndex","regex","stringToJsRegex","matches","alias","match","console","info","timeBlockArray","dataSeries","dataPointIndex","flotpairs","dataSeriesCopy","datapoints","count","timestamp","seriesData","target","getFlotPairs","override","without","thresholdCount","colorCount","refresh","colorIndex","splice","Math","apply","absoluteDistance","valueDistanceFromMin","seriesItemAlias","seriesItem","colorData","overrides","i","strVale","Number","trim","colorMap","valueName","reverse","pos","idString","scope","elem","attrs","ctrl","chartElement","find","append","chartContainer","css","height","gradientValueMax","gradientValueMin","visFormat","opts","timestampFormat","getGroupKeys","d3plus","string","title","updateSize","updateCanvasStyle","updateChart","clientWidth","canvasContext","clearRect","grd","createLinearGradient","colorWidth","currentColor","addColorStop","fillStyle","fillRect","innerText","getVisSize","dataPoint","getVisColor","rgbColor","getGradientForValue","hexColor","d3","select","selectAll","remove","idKeys","Array","from","aggs","aggregationFunction","viz","dev","container","showLegend","type","uniq","size","draw","onRender","renderingCompleted","templateUrl"],"mappings":"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","file":"heatmapControl.js","sourcesContent":["import './libs/d3/d3';\r\nimport TimeSeries from 'app/core/time_series2';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {heatmapEditor, displayEditor, pluginName} from './properties';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport './series_overrides_heatmap_ctrl';\r\nimport './css/heatmap.css!';\r\n\r\nconst panelOptions = {\r\n\taggregationFunctions: ['avg', 'min', 'max', 'total', 'current', 'count', 'reverse'],\r\n\ttreeMap:{\r\n    \tmodes: ['squarify', 'slice', 'dice', 'slice-dice'],\r\n    \taggregationFunctions: ['sum', 'min', 'max', 'extent', 'mean', 'median', 'quantile', 'variance', 'deviation'],\r\n    \ttimestampFormats: ['YYYY-MM-DDTHH', 'YYYY-MM-DDTHH:mm', 'YYYY-MM-DDTHH:mm:ss', 'YYYY-MM-DDTHH:mm:ss.sssZ']\r\n\t}\r\n};\r\n\r\nconst panelDefaults = {\r\n\t// other style overrides\r\n    seriesOverrides: [],\r\n\tthresholds: '0,10',\r\n\tcolors: ['rgba(50, 172, 45, 1)', 'rgba(241, 255, 0, 1)', 'rgba(245, 54, 54, 1)'],\r\n\tlegend: {\r\n\t\tshow: true,\r\n\t\tmin: true,\r\n\t\tmax: true,\r\n\t\tavg: true,\r\n\t\tcurrent: true,\r\n\t\ttotal: true\r\n\t},\r\n  /**\r\n   * @detangleEdit start\r\n   * @author Ural\r\n   */\r\n  // Detangle Options\r\n  detangle: {\r\n    coupling: false,\r\n    sortingOrder: 'desc',\r\n    limit: null,\r\n    metric: 'coupling',\r\n    sourceType: '$issue_type',\r\n    targetType: '$target_issue_type',\r\n    sourceTypeData: '',\r\n    targetTypeData: '',\r\n\tminIssuesPerFile: null,\r\n\tminIssuesData: '',\r\n\tminFilesPerIssue: null,\r\n\tminFilesData: '',\r\n    issueTitle: '$issue_title',\r\n    issueTitleData: '',\r\n    fileExcludeFilter: '$file_exclude',\r\n\tfileExcludeFilterData: '',\r\n\tfileGroup: '$file_group',\r\n\tfileGroupData: '',\r\n    metricRange: '$metric_range',\r\n    metricRangeData: '',\r\n    cohesionCalculationMethod: 'standard',\r\n    isAuthorDashboard: false,\r\n  },\r\n  /**\r\n   * @detangleEdit end\r\n   * @author Ural\r\n   */\r\n\tmaxDataPoints: 100,\r\n\tmappingType: 1,\r\n\tnullPointMode: 'connected',\r\n\tformat: 'none',\r\n    valueMaps: [\r\n      { value: 'null', op: '=', text: 'N/A' }\r\n    ],\r\n    treeMap: {\r\n    \tmode: 'squarify',\r\n    \tgroups: [{key:'server', value: '/^.*\\./g'}],\r\n    \tcolorByFunction: 'max',\r\n    \tsizeByFunction: 'constant',\r\n    \tenableTimeBlocks: false,\r\n    \tenableGrouping: true,\r\n    \tdebug: false,\r\n    \tdepth: 0,\r\n    \tids: ['alias'],\r\n    \tnodeSizeProperty: \"value\"\r\n    }\r\n};\r\n\r\nclass HeatmapCtrl extends MetricsPanelCtrl {\r\n\tconstructor($scope, $injector, $sce, detangleSrv, templateSrv) {\r\n\t\tsuper($scope, $injector);\r\n\t\t_.defaults(this.panel, panelDefaults);\r\n    this.detangleSrv = detangleSrv;\r\n    this.templateSrv = templateSrv;\r\n\t\tthis.options = panelOptions;\r\n\t\tthis.panel.chartId = 'chart_' + this.panel.id;\r\n\t\tthis.containerDivId = 'container_'+this.panel.chartId;\r\n\t\tthis.$sce = $sce;\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n\t\tthis.initializePanel();\r\n\t}\r\n\r\n\tinitializePanel(){\r\n\t\tvar d3plusPath = 'plugins/'+pluginName+'/libs/d3plus/d3plus.full.js';\r\n\t\tvar _this = this;\r\n\t\tvar meta = {};\r\n\t\tmeta[d3plusPath] = {\r\n\t\t\t      format: 'global'\r\n\t    };\r\n\r\n\t\tSystemJS.config({\r\n\t\t\t  meta: meta\r\n\t\t\t});\r\n\r\n\t\tSystemJS.import(d3plusPath).then(function d3plusLoaded(){\r\n\t\t\t_this.events.emit('data-received');\r\n\t\t});\r\n\r\n    /**\r\n     * @detangleEdit start\r\n     * @author Ural\r\n     */\r\n    this.sortingOrder = [\r\n      {text: 'Ascending', value: 'asc'},\r\n      {text: 'Descending', value: 'desc'},\r\n    ];\r\n\r\n    this.couplingMetrics = [\r\n      {text: 'Coupling Value', value: 'coupling'},\r\n      {text: 'Num. of Couples', value: 'couplecounts'},\r\n      {text: 'Cohesion Value', value: 'cohesion'},\r\n\r\n    ];\r\n\r\n    this.cohesionCalculationMethods = [\r\n      {\r\n        text: 'Standard', value: 'standard'\r\n      },\r\n      {\r\n        text: 'Double', value: 'double'\r\n      }\r\n    ];\r\n    /**\r\n     * @detangleEdit end\r\n     * @author Ural\r\n     */\r\n\t}\r\n\r\n\thandleError(err){\r\n\t\tthis.getPanelContainer().html('<p>Error:</p><pre>' + err + '</pre>');\r\n\t}\r\n\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Heatmap', heatmapEditor, 2);\r\n\t\tthis.addEditorTab('Display', displayEditor, 3);\r\n    this.addEditorTab('Detangle', 'public/app/plugins/panel/graph/detangle.html', 4);\r\n\r\n  }\r\n\r\n\tgetPanelContainer(){\r\n\t\treturn $(document.getElementById(this.containerDivId));\r\n\t}\r\n\r\n\tonDataReceived(dataList){\r\n\t\tif(undefined != dataList) {\r\n      /**\r\n       * @detangleEdit start\r\n       * @author Ural\r\n       */\r\n\r\n      if (this.panel.detangle.coupling) {\r\n        dataList = this.detangleSrv.dataConvertor(dataList, this.templateSrv, this.panel.detangle);\r\n      }\r\n      /**\r\n       * @detangleEdit end\r\n       * @author Ural\r\n       */\r\n\t\t\tthis.series = dataList.map(this.seriesHandler.bind(this));\r\n\t\t}\r\n\r\n\t\tvar preparedData = this.d3plusDataProcessor(this.series);\r\n\t\tthis.render(preparedData);\r\n\t}\r\n\r\n\tgetGroupKeys(){\r\n\t\treturn this.panel.treeMap.groups.map(function(group){\r\n\t\t\treturn group.key;\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Prepare data for d3plus\r\n\t */\r\n\td3plusDataProcessor(dataArray){\r\n\t\tvar resultArray = [];\r\n\t\tvar hasGroups = (this.panel.treeMap.groups.length > 0)\r\n\r\n\t\tif(!hasGroups){\r\n\t\t\t// just add the original items since there are no groups\r\n\t\t\tfor (var dataIndex=0; dataIndex < dataArray.length; dataIndex++){\r\n\t\t\t\tvar newDataItem = Object.assign({}, dataArray[dataIndex], dataArray[dataIndex].stats);\r\n\t\t\t\tresultArray.push(newDataItem);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Process Groups\r\n\t\t\tvar groupArray = [];\r\n\t\t\tfor(var groupIndex=0; groupIndex<this.panel.treeMap.groups.length; groupIndex++){\r\n\t\t\t\tgroupArray.push({\r\n\t\t\t\t\tkey: this.panel.treeMap.groups[groupIndex].key,\r\n\t\t\t\t\tregex: kbn.stringToJsRegex(this.panel.treeMap.groups[groupIndex].value)\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tfor (var dataIndex=0; dataIndex < dataArray.length; dataIndex++){\r\n\t\t\t\tvar newDataItem = Object.assign({}, dataArray[dataIndex]);\r\n\t\t\t\t// only add the stats if we arent using granular timeblock data\r\n\t\t\t\tif(!this.panel.treeMap.enableTimeBlocks){\r\n\t\t\t\t\tObject.assign(newDataItem, dataArray[dataIndex].stats);\r\n\t\t\t\t}\r\n\t\t\t\tdelete newDataItem.stats;\r\n\r\n\t\t\t\tfor(var groupIndex=0; groupIndex < groupArray.length; groupIndex++){\r\n\t\t\t\t\tvar key = groupArray[groupIndex].key;\r\n\t\t\t\t\tvar regex = groupArray[groupIndex].regex;\r\n\t\t\t\t\tvar matches = newDataItem.alias.match(regex);\r\n\t\t\t\t\tif (matches && matches.length > 0){\r\n\t\t\t\t\t\tnewDataItem[key] = matches[0];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tnewDataItem[key] = 'NA';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tresultArray.push(newDataItem);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\t// If we're using timeBlocks mode\r\n\t\t// replace the aggregated series with individual records\r\n\t\tif(this.panel.treeMap.enableTimeBlocks){\r\n\t\t\tconsole.info('creating timeblock records')\r\n\t\t\tvar timeBlockArray = [];\r\n\t\t\tfor (var dataIndex=0; dataIndex < resultArray.length; dataIndex++){\r\n\t\t\t\tconsole.debug('dataIndex:'+dataIndex+', alias:'+resultArray[dataIndex].alias);\r\n\t\t\t\tvar dataSeries = resultArray[dataIndex];\r\n\t\t\t\tfor(var dataPointIndex=0; dataPointIndex < dataSeries.flotpairs.length; dataPointIndex++){\r\n\t\t\t\t\tvar dataSeriesCopy = Object.assign({}, dataSeries);\r\n\t\t\t\t\tdelete dataSeriesCopy.datapoints;\r\n\t\t\t\t\tdelete dataSeriesCopy.flotpairs;\r\n\t\t\t\t\tdataSeriesCopy.count = 1;\r\n\t\t\t\t\tdataSeriesCopy.timestamp = dataSeries.flotpairs[dataPointIndex][0];\r\n\t\t\t\t\tdataSeriesCopy.value = dataSeries.flotpairs[dataPointIndex][1];\r\n\t\t\t\t\ttimeBlockArray.push(dataSeriesCopy);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tresultArray = timeBlockArray;\r\n\t\t}\r\n\r\n\t\treturn resultArray;\r\n\t}\r\n\r\n\t/**\r\n\t * Series Handler\r\n\t */\r\n\tseriesHandler(seriesData) {\r\n\t\tvar series = new TimeSeries({\r\n\t\t\tdatapoints: seriesData.datapoints,\r\n\t\t\talias: seriesData.target.replace(/\"|,|;|=|:|{|}/g, '_')\r\n\t\t});\r\n\t    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n\t    return series;\r\n\t} // End seriesHandler()\r\n\r\n\taddSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides.push(override || {});\r\n\t}\r\n\r\n\taddTreeMapGroup(group) {\r\n\t\tthis.panel.treeMap.groups.push(group || {});\r\n\t}\r\n\r\n\tremoveSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides = _.without(this.panel.seriesOverrides, override);\r\n\t    this.render();\r\n\t}\r\n\r\n\tremoveTreeMapGroup(group) {\r\n\t\tthis.panel.treeMap.groups = _.without(this.panel.treeMap.groups, group);\r\n\t    this.render();\r\n\t}\r\n\r\n\tupdateThresholds(){\r\n\t\tvar thresholdCount = this.panel.thresholds.length;\r\n\t\tvar colorCount = this.panel.colors.length;\r\n\t\tthis.refresh();\r\n\t}\r\n\r\n\tchangeColor(colorIndex, color){\r\n\t\tthis.panel.colors[colorIndex] = color;\r\n\t}\r\n\r\n\tremoveColor(colorIndex){\r\n\t\tthis.panel.colors.splice(colorIndex,1);\r\n\t}\r\n\r\n\taddColor(){\r\n\t\tthis.panel.colors.push('rgba(255, 255, 255, 1)');\r\n\t}\r\n\r\n\tgetGradientForValue(data, value){\r\n\t\tvar min = Math.min.apply(Math, data.thresholds);\r\n\t\tvar max = Math.max.apply(Math, data.thresholds);\r\n\t\tvar absoluteDistance = max - min;\r\n\t\tvar valueDistanceFromMin = value - min;\r\n\t\tvar xPercent = valueDistanceFromMin/absoluteDistance;\r\n\t\t// Get the smaller number to clamp at 0.99 max\r\n\t\txPercent = Math.min(0.99, xPercent);\r\n\t\t// Get the larger number to clamp at 0.01 min\r\n\t\txPercent = Math.max(0.01, xPercent);\r\n\r\n\t\treturn getColorByXPercentage(this.canvas, xPercent);\r\n\t}\r\n\r\n\tapplyOverrides(seriesItemAlias){\r\n\t\tvar seriesItem = {}, colorData = {}, overrides = {};\r\n\t\tconsole.info('applying overrides for seriesItem');\r\n\t\tconsole.debug(seriesItemAlias);\r\n\t\tconsole.debug(this.panel.seriesOverrides);\r\n\t\tfor(var i=0; i<=this.panel.seriesOverrides.length; i++){\r\n\t\t\tconsole.debug('comparing:');\r\n\t\t\tconsole.debug(this.panel.seriesOverrides[i]);\r\n\t\t\tif (this.panel.seriesOverrides[i] && this.panel.seriesOverrides[i].alias == seriesItemAlias){\r\n\t\t\t\toverrides = this.panel.seriesOverrides[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\tcolorData.thresholds = (overrides.thresholds || this.panel.thresholds).split(',').map(function(strVale) {\r\n\t\t\treturn Number(strVale.trim());\r\n\t\t});\r\n\t\tcolorData.colorMap = this.panel.colors;\r\n\t\tseriesItem.colorData = colorData;\r\n\r\n\t\tseriesItem.valueName = overrides.valueName || this.panel.valueName;\r\n\r\n\t\treturn seriesItem;\r\n\t}\r\n\r\n\tinvertColorOrder() {\r\n\t    this.panel.colors.reverse();\r\n\t    this.refresh();\r\n\t}\r\n\r\n\taddTreeMapId(){\r\n\t\tthis.panel.treeMap.ids.push('');\r\n\t\tthis.refresh();\r\n\t}\r\n\r\n\tremoveTreeMapId(pos){\r\n\t\tthis.panel.treeMap.ids.splice(pos,1);\r\n\t\tthis.refresh();\r\n\t}\r\n\r\n\tchangeTreeMapId(idString, pos){\r\n\t\tthis.panel.treeMap.ids[pos] = idString;\r\n\t}\r\n\r\n\t// #############################################\r\n\t// link\r\n\t// #############################################\r\n\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t\tvar chartElement = elem.find('.heatmap');\r\n\t\tchartElement.append('<div id=\"'+ctrl.containerDivId+'\"></div>');\r\n\t    var chartContainer = $(document.getElementById(ctrl.containerDivId));\r\n    \tconsole.debug('found chartContainer');\r\n    \tconsole.debug(chartContainer);\r\n    \telem.css('height', ctrl.height + 'px');\r\n\r\n    \tvar canvas = elem.find('.canvas')[0];\r\n\t    ctrl.canvas = canvas;\r\n\t    var gradientValueMax = elem.find('.gradient-value-max')[0];\r\n\t    var gradientValueMin = elem.find('.gradient-value-min')[0];\r\n\r\n\r\n    \tvar visFormat =\r\n\t\t{\r\n\t\t\t\"text\" : function(text, opts) {\r\n\t\t\t\tif(opts.key == 'timestamp'){\r\n\t\t\t\t\tvar timestamp = moment(Number(text));\r\n\t\t\t\t\treturn timestamp.format(ctrl.panel.treeMap.timestampFormat);\r\n\t\t\t\t}\r\n\t\t\t\telse if(ctrl.getGroupKeys().indexOf(opts.key)>-1) {\r\n\t\t\t\t\treturn text;\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\treturn d3plus.string.title(text, opts);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\r\n    \tfunction render(data){\r\n    \t\tupdateSize();\r\n    \t\tupdateCanvasStyle();\r\n    \t\tupdateChart(data);\r\n    \t}\r\n\r\n    \tfunction updateCanvasStyle(){\r\n\t    \tcanvas.width = Math.max(chartElement[0].clientWidth, 100);\r\n\t\t\tvar canvasContext = canvas.getContext(\"2d\");\r\n\t\t\tcanvasContext.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n\t\t\tvar grd = canvasContext.createLinearGradient(0, 0, canvas.width, 0);\r\n\t\t\tvar colorWidth = 1 / Math.max(ctrl.panel.colors.length, 1);\r\n\t\t\tfor(var i=0; i<ctrl.panel.colors.length; i++){\r\n\t\t\t\tvar currentColor = ctrl.panel.colors[i];\r\n\t\t\t\tgrd.addColorStop(Math.min(colorWidth*i,1), currentColor);\r\n\t\t\t}\r\n\t\t\tcanvasContext.fillStyle = grd;\r\n\t\t\tcanvasContext.fillRect(0, 0, canvas.width, 3);\r\n    \t\tctrl.canvasContext = canvasContext;\r\n\r\n\t\t\tgradientValueMax.innerText = Math.max.apply(Math, ctrl.panel.thresholds.split(','));\r\n\t\t\tgradientValueMin.innerText = Math.min.apply(Math, ctrl.panel.thresholds.split(','));\r\n    \t}\r\n\r\n    \tfunction updateSize(){\r\n    \t\telem.css('height', ctrl.height + 'px');\r\n    \t}\r\n\r\n    \tfunction getVisSize(dataPoint){\r\n    \t\tif(ctrl.panel.treeMap.sizeByFunction == 'constant') {\r\n    \t\t\treturn 1;\r\n        }\r\n    \t\telse if (ctrl.panel.treeMap.sizeByFunction == 'reverse') {\r\n    \t\t\treturn 1 / dataPoint['total'];\r\n\t\t\t\t}\r\n    \t\telse {\r\n        \t\treturn dataPoint[ctrl.panel.treeMap.sizeByFunction] || dataPoint.value;\r\n    \t\t}\r\n    \t}\r\n\r\n    \tfunction getVisColor(dataPoint){\r\n    \t\tvar value = dataPoint[ctrl.panel.treeMap.colorByFunction] || dataPoint.value;\r\n    \t\tvar rgbColor = ctrl.getGradientForValue({thresholds: ctrl.panel.thresholds.split(',')}, value);\r\n\t\t\tvar hexColor = colorToHex(rgbColor);\r\n\t\t\treturn hexColor;\r\n    \t}\r\n\r\n\r\n    \tfunction updateChart(data){\r\n    \t\td3.select(\"#\"+ctrl.containerDivId).selectAll('*').remove();\r\n\r\n    \t\t// Make sure the necessary IDs are added\r\n    \t\tvar idKeys = Array.from(ctrl.panel.treeMap.ids);\r\n    \t\tif(idKeys.length == 0){\r\n    \t\t\tensureArrayContains(idKeys, 'alias');\r\n    \t\t}\r\n    \t\tif(ctrl.panel.treeMap.enableTimeBlocks){\r\n    \t\t\tensureArrayContains(idKeys, 'timestamp');\r\n    \t\t}\r\n\r\n    \t\t// Setup Aggregations\r\n    \t\tvar aggs = {};\r\n    \t\taggs.value = ctrl.panel.treeMap.aggregationFunction;\r\n    \t\taggs.current = ctrl.panel.treeMap.aggregationFunction;\r\n    \t\taggs.count = 'sum';\r\n    \t\taggs.total = 'sum';\r\n    \t\taggs.avg = 'mean';\r\n    \t\taggs.min = 'min';\r\n    \t\taggs.max = 'max';\r\n\r\n    \t\td3plus.viz()\r\n\t\t\t\t.dev(ctrl.panel.treeMap.debug)\r\n    \t\t\t.aggs(aggs)\r\n    \t\t\t.container(\"#\"+ctrl.containerDivId)\r\n    \t\t\t.legend(ctrl.panel.treeMap.showLegend)\r\n    \t\t\t.data(data)\r\n    \t\t\t//.type(\"tree_map\")\r\n    \t\t\t.type({\"mode\": ctrl.panel.treeMap.mode})    // sets the mode of visualization display based on type\r\n    \t\t\t.id({\r\n    \t\t\t\t\"value\": _.uniq(idKeys),\r\n    \t\t\t\t\"grouping\": ctrl.panel.treeMap.enableGrouping\r\n    \t\t\t})\r\n    \t\t\t.depth(Number(ctrl.panel.treeMap.depth))\r\n    \t\t\t.size(getVisSize)\r\n    \t\t\t.height(ctrl.height)\r\n    \t\t\t.width(ctrl.width)\r\n    \t\t\t.color(getVisColor)\r\n    \t\t\t.format(visFormat)\r\n    \t\t\t.draw();\r\n    \t}\r\n\r\n\r\n    \tthis.events.on('render', function onRender(data) {\r\n    \t\tif(typeof d3plus !== 'undefined' && data){\r\n    \t\t\trender(data);\r\n    \t\t\tctrl.renderingCompleted();\r\n    \t\t} else {\r\n    \t\t\tconsole.info('d3plus is not loaded yet');\r\n    \t\t}\r\n\t    });\r\n\r\n\t}\r\n// End Class\r\n}\r\n\r\nfunction ensureArrayContains(array, value) {\r\n\tif (array.indexOf(value) == -1) {\r\n\t\tarray.push(value);\r\n\t}\r\n}\r\n\r\nfunction colorToHex(color) {\r\n    if (color.substr(0, 1) === '#') {\r\n        return color;\r\n    }\r\n    var digits = color.replace(/[rgba\\(\\)\\ ]/g,'').split(',');\r\n    while(digits.length < 3){\r\n    \tdigits.push(255);\r\n    }\r\n\r\n    var red = parseInt(digits[0]);\r\n    var green = parseInt(digits[1]);\r\n    var blue = parseInt(digits[2]);\r\n\r\n    var rgba = blue | (green << 8) | (red << 16);\r\n    return '#' + rgba.toString(16);\r\n};\r\n\r\nfunction getColorByXPercentage(canvas, xPercent){\r\n\tvar x = canvas.width * xPercent || 0;\r\n\tvar context = canvas.getContext(\"2d\");\r\n    var p = context.getImageData(x, 1, 1, 1).data;\r\n    var color = 'rgba('+[p[0] +','+ p[1] +','+ p[2] +','+ p[3]]+')';\r\n    return color;\r\n}\r\n\r\nHeatmapCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n\tHeatmapCtrl,\r\n\tHeatmapCtrl as MetricsPanelCtrl\r\n};\r\n"]}