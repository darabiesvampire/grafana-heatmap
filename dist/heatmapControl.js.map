{"version":3,"sources":["../src/heatmapControl.js"],"names":["ensureArrayContains","array","value","indexOf","push","colorToHex","color","substr","digits","replace","split","length","red","parseInt","green","blue","rgba","toString","getColorByXPercentage","canvas","xPercent","x","width","context","getContext","p","getImageData","data","TimeSeries","kbn","MetricsPanelCtrl","heatmapEditor","displayEditor","pluginName","_","moment","panelOptions","aggregationFunctions","treeMap","modes","timestampFormats","panelDefaults","seriesOverrides","thresholds","colors","legend","show","min","max","avg","current","total","detangle","coupling","sortingOrder","limit","metric","sourceType","targetType","sourceTypeData","targetTypeData","maxDataPoints","mappingType","nullPointMode","format","valueMaps","op","text","mode","groups","key","colorByFunction","sizeByFunction","enableTimeBlocks","enableGrouping","debug","depth","ids","nodeSizeProperty","HeatmapCtrl","$scope","$injector","$sce","detangleSrv","templateSrv","defaults","panel","options","chartId","id","containerDivId","events","on","onInitEditMode","bind","onDataReceived","initializePanel","d3plusPath","_this","meta","SystemJS","config","import","then","d3plusLoaded","emit","couplingMetrics","err","getPanelContainer","html","addEditorTab","$","document","getElementById","dataList","undefined","replaceWithText","scopedVars","dataConvertor","series","map","seriesHandler","preparedData","d3plusDataProcessor","render","group","dataArray","resultArray","hasGroups","dataIndex","newDataItem","Object","assign","stats","groupArray","groupIndex","regex","stringToJsRegex","matches","alias","match","console","info","timeBlockArray","dataSeries","dataPointIndex","flotpairs","dataSeriesCopy","datapoints","count","timestamp","seriesData","target","getFlotPairs","override","without","thresholdCount","colorCount","refresh","colorIndex","splice","Math","apply","absoluteDistance","valueDistanceFromMin","seriesItemAlias","seriesItem","colorData","overrides","i","strVale","Number","trim","colorMap","valueName","reverse","pos","idString","scope","elem","attrs","ctrl","chartElement","find","append","chartContainer","css","height","gradientValueMax","gradientValueMin","visFormat","opts","timestampFormat","getGroupKeys","d3plus","string","title","updateSize","updateCanvasStyle","updateChart","clientWidth","canvasContext","clearRect","grd","createLinearGradient","colorWidth","currentColor","addColorStop","fillStyle","fillRect","innerText","getVisSize","dataPoint","getVisColor","rgbColor","getGradientForValue","hexColor","d3","select","selectAll","remove","idKeys","Array","from","aggs","aggregationFunction","viz","dev","container","showLegend","type","uniq","size","draw","onRender","renderingCompleted","templateUrl"],"mappings":"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","file":"heatmapControl.js","sourcesContent":["import './libs/d3/d3';\r\nimport TimeSeries from 'app/core/time_series2';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {heatmapEditor, displayEditor, pluginName} from './properties';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport './series_overrides_heatmap_ctrl';\r\nimport './css/heatmap.css!';\r\n\r\nconst panelOptions = {\r\n\taggregationFunctions: ['avg', 'min', 'max', 'total', 'current', 'count'],\r\n\ttreeMap:{\r\n    \tmodes: ['squarify', 'slice', 'dice', 'slice-dice'],\r\n    \taggregationFunctions: ['sum', 'min', 'max', 'extent', 'mean', 'median', 'quantile', 'variance', 'deviation'],\r\n    \ttimestampFormats: ['YYYY-MM-DDTHH', 'YYYY-MM-DDTHH:mm', 'YYYY-MM-DDTHH:mm:ss', 'YYYY-MM-DDTHH:mm:ss.sssZ']\r\n\t}\r\n};\r\n\r\nconst panelDefaults = {\r\n\t// other style overrides\r\n    seriesOverrides: [],\r\n\tthresholds: '0,10',\r\n\tcolors: ['rgba(50, 172, 45, 1)', 'rgba(241, 255, 0, 1)', 'rgba(245, 54, 54, 1)'],\r\n\tlegend: {\r\n\t\tshow: true,\r\n\t\tmin: true,\r\n\t\tmax: true,\r\n\t\tavg: true,\r\n\t\tcurrent: true,\r\n\t\ttotal: true\r\n\t},\r\n  /**\r\n   * @detangleEdit start\r\n   * @author Ural\r\n   */\r\n  // Detangle Options\r\n  detangle: {\r\n    coupling: false,\r\n    sortingOrder: 'desc',\r\n    limit: null,\r\n    metric: 'coupling',\r\n    sourceType: '$issue_type',\r\n    targetType: '$target_issue_type',\r\n    sourceTypeData: '',\r\n    targetTypeData: '',\r\n  },\r\n  /**\r\n   * @detangleEdit end\r\n   * @author Ural\r\n   */\r\n\tmaxDataPoints: 100,\r\n\tmappingType: 1,\r\n\tnullPointMode: 'connected',\r\n\tformat: 'none',\r\n    valueMaps: [\r\n      { value: 'null', op: '=', text: 'N/A' }\r\n    ],\r\n    treeMap: {\r\n    \tmode: 'squarify',\r\n    \tgroups: [{key:'server', value: '/^.*\\./g'}],\r\n    \tcolorByFunction: 'max',\r\n    \tsizeByFunction: 'constant',\r\n    \tenableTimeBlocks: false,\r\n    \tenableGrouping: true,\r\n    \tdebug: false,\r\n    \tdepth: 0,\r\n    \tids: ['alias'],\r\n    \tnodeSizeProperty: \"value\"\r\n    }\r\n};\r\n\r\nclass HeatmapCtrl extends MetricsPanelCtrl {\r\n\tconstructor($scope, $injector, $sce, detangleSrv, templateSrv) {\r\n\t\tsuper($scope, $injector);\r\n\t\t_.defaults(this.panel, panelDefaults);\r\n    this.detangleSrv = detangleSrv;\r\n    this.templateSrv = templateSrv;\r\n\t\tthis.options = panelOptions;\r\n\t\tthis.panel.chartId = 'chart_' + this.panel.id;\r\n\t\tthis.containerDivId = 'container_'+this.panel.chartId;\r\n\t\tthis.$sce = $sce;\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n\t\tthis.initializePanel();\r\n\t}\r\n\r\n\tinitializePanel(){\r\n\t\tvar d3plusPath = 'plugins/'+pluginName+'/libs/d3plus/d3plus.full.js';\r\n\t\tvar _this = this;\r\n\t\tvar meta = {};\r\n\t\tmeta[d3plusPath] = {\r\n\t\t\t      format: 'global'\r\n\t    };\r\n\r\n\t\tSystemJS.config({\r\n\t\t\t  meta: meta\r\n\t\t\t});\r\n\r\n\t\tSystemJS.import(d3plusPath).then(function d3plusLoaded(){\r\n\t\t\t_this.events.emit('data-received');\r\n\t\t});\r\n\r\n    /**\r\n     * @detangleEdit start\r\n     * @author Ural\r\n     */\r\n    this.sortingOrder = [\r\n      {text: 'Ascending', value: 'asc'},\r\n      {text: 'Descending', value: 'desc'},\r\n    ];\r\n\r\n    this.couplingMetrics = [\r\n      {text: 'Coupling Value', value: 'coupling'},\r\n      {text: 'Num. of Couples', value: 'couplecounts'},\r\n    ];\r\n    /**\r\n     * @detangleEdit end\r\n     * @author Ural\r\n     */\r\n\t}\r\n\r\n\thandleError(err){\r\n\t\tthis.getPanelContainer().html('<p>Error:</p><pre>' + err + '</pre>');\r\n\t}\r\n\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Heatmap', heatmapEditor, 2);\r\n\t\tthis.addEditorTab('Display', displayEditor, 3);\r\n    this.addEditorTab('Detangle', 'public/app/plugins/panel/graph/detangle.html', 4);\r\n\r\n  }\r\n\r\n\tgetPanelContainer(){\r\n\t\treturn $(document.getElementById(this.containerDivId));\r\n\t}\r\n\r\n\tonDataReceived(dataList){\r\n\t\tif(undefined != dataList) {\r\n      /**\r\n       * @detangleEdit start\r\n       * @author Ural\r\n       */\r\n      this.panel.detangle.sourceTypeData = this.templateSrv.replaceWithText(this.panel.detangle.sourceType, this.panel.scopedVars);\r\n      this.panel.detangle.targetTypeData = this.templateSrv.replaceWithText(this.panel.detangle.targetType, this.panel.scopedVars);\r\n\r\n      if (this.panel.detangle.coupling) {\r\n        dataList = this.detangleSrv.dataConvertor(dataList, this.panel.detangle, 'file');\r\n      }\r\n      /**\r\n       * @detangleEdit end\r\n       * @author Ural\r\n       */\r\n\t\t\tthis.series = dataList.map(this.seriesHandler.bind(this));\r\n\t\t}\r\n\r\n\t\tvar preparedData = this.d3plusDataProcessor(this.series);\r\n\t\tthis.render(preparedData);\r\n\t}\r\n\r\n\tgetGroupKeys(){\r\n\t\treturn this.panel.treeMap.groups.map(function(group){\r\n\t\t\treturn group.key;\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Prepare data for d3plus\r\n\t */\r\n\td3plusDataProcessor(dataArray){\r\n\t\tvar resultArray = [];\r\n\t\tvar hasGroups = (this.panel.treeMap.groups.length > 0)\r\n\r\n\t\tif(!hasGroups){\r\n\t\t\t// just add the original items since there are no groups\r\n\t\t\tfor (var dataIndex=0; dataIndex < dataArray.length; dataIndex++){\r\n\t\t\t\tvar newDataItem = Object.assign({}, dataArray[dataIndex], dataArray[dataIndex].stats);\r\n\t\t\t\tresultArray.push(newDataItem);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Process Groups\r\n\t\t\tvar groupArray = [];\r\n\t\t\tfor(var groupIndex=0; groupIndex<this.panel.treeMap.groups.length; groupIndex++){\r\n\t\t\t\tgroupArray.push({\r\n\t\t\t\t\tkey: this.panel.treeMap.groups[groupIndex].key,\r\n\t\t\t\t\tregex: kbn.stringToJsRegex(this.panel.treeMap.groups[groupIndex].value)\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tfor (var dataIndex=0; dataIndex < dataArray.length; dataIndex++){\r\n\t\t\t\tvar newDataItem = Object.assign({}, dataArray[dataIndex]);\r\n\t\t\t\t// only add the stats if we arent using granular timeblock data\r\n\t\t\t\tif(!this.panel.treeMap.enableTimeBlocks){\r\n\t\t\t\t\tObject.assign(newDataItem, dataArray[dataIndex].stats);\r\n\t\t\t\t}\r\n\t\t\t\tdelete newDataItem.stats;\r\n\r\n\t\t\t\tfor(var groupIndex=0; groupIndex < groupArray.length; groupIndex++){\r\n\t\t\t\t\tvar key = groupArray[groupIndex].key;\r\n\t\t\t\t\tvar regex = groupArray[groupIndex].regex;\r\n\t\t\t\t\tvar matches = newDataItem.alias.match(regex);\r\n\t\t\t\t\tif (matches && matches.length > 0){\r\n\t\t\t\t\t\tnewDataItem[key] = matches[0];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tnewDataItem[key] = 'NA';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tresultArray.push(newDataItem);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\t// If we're using timeBlocks mode\r\n\t\t// replace the aggregated series with individual records\r\n\t\tif(this.panel.treeMap.enableTimeBlocks){\r\n\t\t\tconsole.info('creating timeblock records')\r\n\t\t\tvar timeBlockArray = [];\r\n\t\t\tfor (var dataIndex=0; dataIndex < resultArray.length; dataIndex++){\r\n\t\t\t\tconsole.debug('dataIndex:'+dataIndex+', alias:'+resultArray[dataIndex].alias);\r\n\t\t\t\tvar dataSeries = resultArray[dataIndex];\r\n\t\t\t\tfor(var dataPointIndex=0; dataPointIndex < dataSeries.flotpairs.length; dataPointIndex++){\r\n\t\t\t\t\tvar dataSeriesCopy = Object.assign({}, dataSeries);\r\n\t\t\t\t\tdelete dataSeriesCopy.datapoints;\r\n\t\t\t\t\tdelete dataSeriesCopy.flotpairs;\r\n\t\t\t\t\tdataSeriesCopy.count = 1;\r\n\t\t\t\t\tdataSeriesCopy.timestamp = dataSeries.flotpairs[dataPointIndex][0];\r\n\t\t\t\t\tdataSeriesCopy.value = dataSeries.flotpairs[dataPointIndex][1];\r\n\t\t\t\t\ttimeBlockArray.push(dataSeriesCopy);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tresultArray = timeBlockArray;\r\n\t\t}\r\n\r\n\t\treturn resultArray;\r\n\t}\r\n\r\n\t/**\r\n\t * Series Handler\r\n\t */\r\n\tseriesHandler(seriesData) {\r\n\t\tvar series = new TimeSeries({\r\n\t\t\tdatapoints: seriesData.datapoints,\r\n\t\t\talias: seriesData.target.replace(/\"|,|;|=|:|{|}/g, '_')\r\n\t\t});\r\n\t    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n\t    return series;\r\n\t} // End seriesHandler()\r\n\r\n\taddSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides.push(override || {});\r\n\t}\r\n\r\n\taddTreeMapGroup(group) {\r\n\t\tthis.panel.treeMap.groups.push(group || {});\r\n\t}\r\n\r\n\tremoveSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides = _.without(this.panel.seriesOverrides, override);\r\n\t    this.render();\r\n\t}\r\n\r\n\tremoveTreeMapGroup(group) {\r\n\t\tthis.panel.treeMap.groups = _.without(this.panel.treeMap.groups, group);\r\n\t    this.render();\r\n\t}\r\n\r\n\tupdateThresholds(){\r\n\t\tvar thresholdCount = this.panel.thresholds.length;\r\n\t\tvar colorCount = this.panel.colors.length;\r\n\t\tthis.refresh();\r\n\t}\r\n\r\n\tchangeColor(colorIndex, color){\r\n\t\tthis.panel.colors[colorIndex] = color;\r\n\t}\r\n\r\n\tremoveColor(colorIndex){\r\n\t\tthis.panel.colors.splice(colorIndex,1);\r\n\t}\r\n\r\n\taddColor(){\r\n\t\tthis.panel.colors.push('rgba(255, 255, 255, 1)');\r\n\t}\r\n\r\n\tgetGradientForValue(data, value){\r\n\t\tvar min = Math.min.apply(Math, data.thresholds);\r\n\t\tvar max = Math.max.apply(Math, data.thresholds);\r\n\t\tvar absoluteDistance = max - min;\r\n\t\tvar valueDistanceFromMin = value - min;\r\n\t\tvar xPercent = valueDistanceFromMin/absoluteDistance;\r\n\t\t// Get the smaller number to clamp at 0.99 max\r\n\t\txPercent = Math.min(0.99, xPercent);\r\n\t\t// Get the larger number to clamp at 0.01 min\r\n\t\txPercent = Math.max(0.01, xPercent);\r\n\r\n\t\treturn getColorByXPercentage(this.canvas, xPercent);\r\n\t}\r\n\r\n\tapplyOverrides(seriesItemAlias){\r\n\t\tvar seriesItem = {}, colorData = {}, overrides = {};\r\n\t\tconsole.info('applying overrides for seriesItem');\r\n\t\tconsole.debug(seriesItemAlias);\r\n\t\tconsole.debug(this.panel.seriesOverrides);\r\n\t\tfor(var i=0; i<=this.panel.seriesOverrides.length; i++){\r\n\t\t\tconsole.debug('comparing:');\r\n\t\t\tconsole.debug(this.panel.seriesOverrides[i]);\r\n\t\t\tif (this.panel.seriesOverrides[i] && this.panel.seriesOverrides[i].alias == seriesItemAlias){\r\n\t\t\t\toverrides = this.panel.seriesOverrides[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\tcolorData.thresholds = (overrides.thresholds || this.panel.thresholds).split(',').map(function(strVale) {\r\n\t\t\treturn Number(strVale.trim());\r\n\t\t});\r\n\t\tcolorData.colorMap = this.panel.colors;\r\n\t\tseriesItem.colorData = colorData;\r\n\r\n\t\tseriesItem.valueName = overrides.valueName || this.panel.valueName;\r\n\r\n\t\treturn seriesItem;\r\n\t}\r\n\r\n\tinvertColorOrder() {\r\n\t    this.panel.colors.reverse();\r\n\t    this.refresh();\r\n\t}\r\n\r\n\taddTreeMapId(){\r\n\t\tthis.panel.treeMap.ids.push('');\r\n\t\tthis.refresh();\r\n\t}\r\n\r\n\tremoveTreeMapId(pos){\r\n\t\tthis.panel.treeMap.ids.splice(pos,1);\r\n\t\tthis.refresh();\r\n\t}\r\n\r\n\tchangeTreeMapId(idString, pos){\r\n\t\tthis.panel.treeMap.ids[pos] = idString;\r\n\t}\r\n\r\n\t// #############################################\r\n\t// link\r\n\t// #############################################\r\n\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t\tvar chartElement = elem.find('.heatmap');\r\n\t\tchartElement.append('<div id=\"'+ctrl.containerDivId+'\"></div>');\r\n\t    var chartContainer = $(document.getElementById(ctrl.containerDivId));\r\n    \tconsole.debug('found chartContainer');\r\n    \tconsole.debug(chartContainer);\r\n    \telem.css('height', ctrl.height + 'px');\r\n\r\n    \tvar canvas = elem.find('.canvas')[0];\r\n\t    ctrl.canvas = canvas;\r\n\t    var gradientValueMax = elem.find('.gradient-value-max')[0];\r\n\t    var gradientValueMin = elem.find('.gradient-value-min')[0];\r\n\r\n\r\n    \tvar visFormat =\r\n\t\t{\r\n\t\t\t\"text\" : function(text, opts) {\r\n\t\t\t\tif(opts.key == 'timestamp'){\r\n\t\t\t\t\tvar timestamp = moment(Number(text));\r\n\t\t\t\t\treturn timestamp.format(ctrl.panel.treeMap.timestampFormat);\r\n\t\t\t\t}\r\n\t\t\t\telse if(ctrl.getGroupKeys().indexOf(opts.key)>-1) {\r\n\t\t\t\t\treturn text;\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\treturn d3plus.string.title(text, opts);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\r\n    \tfunction render(data){\r\n    \t\tupdateSize();\r\n    \t\tupdateCanvasStyle();\r\n    \t\tupdateChart(data);\r\n    \t}\r\n\r\n    \tfunction updateCanvasStyle(){\r\n\t    \tcanvas.width = Math.max(chartElement[0].clientWidth, 100);\r\n\t\t\tvar canvasContext = canvas.getContext(\"2d\");\r\n\t\t\tcanvasContext.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n\t\t\tvar grd = canvasContext.createLinearGradient(0, 0, canvas.width, 0);\r\n\t\t\tvar colorWidth = 1 / Math.max(ctrl.panel.colors.length, 1);\r\n\t\t\tfor(var i=0; i<ctrl.panel.colors.length; i++){\r\n\t\t\t\tvar currentColor = ctrl.panel.colors[i];\r\n\t\t\t\tgrd.addColorStop(Math.min(colorWidth*i,1), currentColor);\r\n\t\t\t}\r\n\t\t\tcanvasContext.fillStyle = grd;\r\n\t\t\tcanvasContext.fillRect(0, 0, canvas.width, 3);\r\n    \t\tctrl.canvasContext = canvasContext;\r\n\r\n\t\t\tgradientValueMax.innerText = Math.max.apply(Math, ctrl.panel.thresholds.split(','));\r\n\t\t\tgradientValueMin.innerText = Math.min.apply(Math, ctrl.panel.thresholds.split(','));\r\n    \t}\r\n\r\n    \tfunction updateSize(){\r\n    \t\telem.css('height', ctrl.height + 'px');\r\n    \t}\r\n\r\n    \tfunction getVisSize(dataPoint){\r\n    \t\tif(ctrl.panel.treeMap.sizeByFunction == 'constant') return 1;\r\n    \t\telse {\r\n        \t\treturn dataPoint[ctrl.panel.treeMap.sizeByFunction] || dataPoint.value;\r\n    \t\t}\r\n    \t}\r\n\r\n    \tfunction getVisColor(dataPoint){\r\n    \t\tvar value = dataPoint[ctrl.panel.treeMap.colorByFunction] || dataPoint.value;\r\n    \t\tvar rgbColor = ctrl.getGradientForValue({thresholds: ctrl.panel.thresholds.split(',')}, value);\r\n\t\t\tvar hexColor = colorToHex(rgbColor);\r\n\t\t\treturn hexColor;\r\n    \t}\r\n\r\n\r\n    \tfunction updateChart(data){\r\n    \t\td3.select(\"#\"+ctrl.containerDivId).selectAll('*').remove();\r\n\r\n    \t\t// Make sure the necessary IDs are added\r\n    \t\tvar idKeys = Array.from(ctrl.panel.treeMap.ids);\r\n    \t\tif(idKeys.length == 0){\r\n    \t\t\tensureArrayContains(idKeys, 'alias');\r\n    \t\t}\r\n    \t\tif(ctrl.panel.treeMap.enableTimeBlocks){\r\n    \t\t\tensureArrayContains(idKeys, 'timestamp');\r\n    \t\t}\r\n\r\n    \t\t// Setup Aggregations\r\n    \t\tvar aggs = {};\r\n    \t\taggs.value = ctrl.panel.treeMap.aggregationFunction;\r\n    \t\taggs.current = ctrl.panel.treeMap.aggregationFunction;\r\n    \t\taggs.count = 'sum';\r\n    \t\taggs.total = 'sum';\r\n    \t\taggs.avg = 'mean';\r\n    \t\taggs.min = 'min';\r\n    \t\taggs.max = 'max';\r\n\r\n    \t\td3plus.viz()\r\n\t\t\t\t.dev(ctrl.panel.treeMap.debug)\r\n    \t\t\t.aggs(aggs)\r\n    \t\t\t.container(\"#\"+ctrl.containerDivId)\r\n    \t\t\t.legend(ctrl.panel.treeMap.showLegend)\r\n    \t\t\t.data(data)\r\n    \t\t\t//.type(\"tree_map\")\r\n    \t\t\t.type({\"mode\": ctrl.panel.treeMap.mode})    // sets the mode of visualization display based on type\r\n    \t\t\t.id({\r\n    \t\t\t\t\"value\": _.uniq(idKeys),\r\n    \t\t\t\t\"grouping\": ctrl.panel.treeMap.enableGrouping\r\n    \t\t\t})\r\n    \t\t\t.depth(Number(ctrl.panel.treeMap.depth))\r\n    \t\t\t.size(getVisSize)\r\n    \t\t\t.height(ctrl.height)\r\n    \t\t\t.width(ctrl.width)\r\n    \t\t\t.color(getVisColor)\r\n    \t\t\t.format(visFormat)\r\n    \t\t\t.draw();\r\n    \t}\r\n\r\n\r\n    \tthis.events.on('render', function onRender(data) {\r\n    \t\tif(typeof d3plus !== 'undefined' && data){\r\n    \t\t\trender(data);\r\n    \t\t\tctrl.renderingCompleted();\r\n    \t\t} else {\r\n    \t\t\tconsole.info('d3plus is not loaded yet');\r\n    \t\t}\r\n\t    });\r\n\r\n\t}\r\n// End Class\r\n}\r\n\r\nfunction ensureArrayContains(array, value) {\r\n\tif (array.indexOf(value) == -1) {\r\n\t\tarray.push(value);\r\n\t}\r\n}\r\n\r\nfunction colorToHex(color) {\r\n    if (color.substr(0, 1) === '#') {\r\n        return color;\r\n    }\r\n    var digits = color.replace(/[rgba\\(\\)\\ ]/g,'').split(',');\r\n    while(digits.length < 3){\r\n    \tdigits.push(255);\r\n    }\r\n\r\n    var red = parseInt(digits[0]);\r\n    var green = parseInt(digits[1]);\r\n    var blue = parseInt(digits[2]);\r\n\r\n    var rgba = blue | (green << 8) | (red << 16);\r\n    return '#' + rgba.toString(16);\r\n};\r\n\r\nfunction getColorByXPercentage(canvas, xPercent){\r\n\tvar x = canvas.width * xPercent || 0;\r\n\tvar context = canvas.getContext(\"2d\");\r\n    var p = context.getImageData(x, 1, 1, 1).data;\r\n    var color = 'rgba('+[p[0] +','+ p[1] +','+ p[2] +','+ p[3]]+')';\r\n    return color;\r\n}\r\n\r\nHeatmapCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n\tHeatmapCtrl,\r\n\tHeatmapCtrl as MetricsPanelCtrl\r\n};\r\n"]}